#!/bin/bash

# Check if running with root privileges
if [[ $EUID -ne 0 ]]; then
   echo "This script must be run as root" 
   exit 1
fi

# resize fs
echo "Resizing the file system"

root_device=/dev/$(lsblk -no PKNAME,MOUNTPOINT | awk '$2 == "/" {print $1}')
partition_suffix=$(lsblk -no KNAME,MOUNTPOINT | awk '$2 == "/" {gsub(/.*[^0-9]/, "", $1); print $1}')

if [[ $root_device == /dev/sd* ]]; then
  partition_number="${partition_suffix}"
else
  partition_number="p${partition_suffix}"
fi

sudo growpart ${root_device} ${partition_suffix}
sudo resize2fs ${root_device}${partition_number}

# Parse command line arguments
if [[ $# -lt 1 || $# -gt 2 ]]; then
    echo "Usage: $(basename "$0") ROBOT_MODEL ROS_VERSION"
    exit 0
fi

robot_model="$1"

if [ -z "$2" ]; then
  if [ "$IMAGE_TYPE" == "VULCANEXUS_HUMBLE" ]; then
    ros_version="vulcanexus_humble"
  elif [ "$IMAGE_TYPE" == "ROS2_HUMBLE" ]; then
    ros_version="ros2_humble"
  elif [ "$IMAGE_TYPE" == "ROS_NOETIC" ]; then
    ros_version="ros_noetic"
  else
    echo "Error: No ROS version specified"
    exit 1
  fi
else
  ros_version="$2"
fi

echo "Robot model: ${robot_model}"
echo "ROS version: ${ros_version}"

# Check if the robot model is valid
if [[ "$robot_model" != "rosbot_2r" && "$robot_model" != "rosbot_xl" && "$robot_model" != "panther" ]]; then
    echo "Invalid robot model: $robot_model"
    exit 1
fi

# Check if the ROS version is valid
if [[ "$ros_version" != "ros_noetic" && "$ros_version" != "ros2_humble" && "$ros_version" != "vulcanexus_humble" ]]; then
    echo "Invalid ROS version: $ros_version"
    exit 1
fi

cp -rp /etc/husarion/robot_configs/${robot_model}/${ros_version}/* /home/husarion
dpkg -i /etc/husarion/robot_configs/${robot_model}/motd_$(uname -m).deb
cp /etc/husarion/robot_configs/${robot_model}/netplan.yaml /etc/netplan/01-network-manager-all.yaml
bash /usr/lib/husarion/custom_config_${robot_model}.sh

# Print success message
echo ""
echo "Configuration files copied successfully for robot model \"$robot_model\" and ROS version \"$ros_version\""
